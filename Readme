qr-saas/
│
├── cmd/
│   ├── api/
│   │   └── main.go                # Entry point (Initializes Postgres, Redis, Router)
│   └── worker/                    # Background jobs (Email, Subscription checks)
│       └── main.go
│
├── internal/
│   ├── config/
│   │   └── config.go              # Loads .env (PORT, DATABASE_URL, FRONTEND_URL)
│   │
│   ├── db/
│   │   ├── postgres.go            # Connects to Neon (pgxpool)
│   │   └── redis.go               # Connects to Redis (Rate limiting, Caching)
│   │
│   ├── http/
│   │   ├── router.go              # Setup Gin, CORS, Routes
│   │   ├── middleware/
│   │   │   ├── auth.go            # JWT Validation
│   │   │   └── cors.go            # CORS Config
│   │   └── response/              # Standard JSON response helpers
│   │
│   ├── auth/                      # User Authentication
│   │   ├── models.go
│   │   ├── repository.go          # Users Table
│   │   ├── service.go             # Google OAuth / Login Logic
│   │   ├── http_handlers.go
│   │   └── google_oauth.go
│   │
│   ├── qr/                        # QR Management
│   │   ├── models.go              # QRCode Struct
│   │   ├── repository.go          # CRUD for qr_codes table
│   │   ├── service.go             # Create, Update, Delete Logic
│   │   ├── http_handlers.go
│   │   └── render/                # Image Generation (go-qrcode)
│   │
│   ├── analytics/                 # Scan Tracking (Moved to Postgres)
│   │   ├── models.go              # ScanEvent, Summary
│   │   ├── repository.go          # SQL queries for scan_events table
│   │   ├── service.go
│   │   └── http_handlers.go       # GET /analytics/dashboard
│   │
│   ├── redirect/                  # The "Engine" (/r/:code)
│   │   ├── service.go             # Resolve URL -> Log Async -> Return Target
│   │   └── http_handlers.go
│   │
│   ├── projects/                  # Folders
│   │   ├── models.go
│   │   ├── repository.go
│   │   └── http_handlers.go
│   │
│   ├── billing/                   # Stripe Integration
│   │   ├── models.go
│   │   ├── repository.go          # Subscriptions table
│   │   ├── service.go             # Stripe Webhook logic
│   │   └── http_handlers.go
│   │
│   └── settings/                  # User Profile
│       ├── models.go
│       └── http_handlers.go
│
├── migrations/                    # SQL Scripts for Database
│   ├── 001_init_schema.up.sql
│   └── 002_add_analytics.up.sql
│
├── assets/                        # Static assets (logos, templates)
├── go.mod
├── go.sum
└── .env

-- 1. USERS
CREATE TABLE users (
    id           UUID PRIMARY KEY,
    email        TEXT UNIQUE NOT NULL,
    password_hash TEXT,            -- Nullable for Google Auth users
    name         TEXT,
    avatar_url   TEXT,
    provider     TEXT NOT NULL,    -- 'google' or 'local'
    provider_id  TEXT,
    role         TEXT DEFAULT 'user',
    created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. PROJECTS (Folders)
CREATE TABLE projects (
    id           UUID PRIMARY KEY,
    user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name         TEXT NOT NULL,
    color        TEXT,
    created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. QR CODES
CREATE TABLE qr_codes (
    id           UUID PRIMARY KEY,
    user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    project_id   UUID REFERENCES projects(id) ON DELETE SET NULL,
    
    name         TEXT,
    qr_type      TEXT NOT NULL,    -- 'url', 'wifi', 'vcard', 'pdf'
    short_code   TEXT UNIQUE NOT NULL,
    target_url   TEXT,             -- Stores URL for dynamic, or Raw Content for static
    design_json  JSONB,            -- Stores Colors, Logo, Shapes
    
    is_active    BOOLEAN DEFAULT TRUE,
    created_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. SCAN EVENTS (Analytics - Formerly ClickHouse)
CREATE TABLE scan_events (
    id           UUID PRIMARY KEY,
    qr_id        UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,
    user_id      UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    scanned_at   TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Metadata from User Agent / IP
    ip           TEXT,
    country      TEXT,
    city         TEXT,
    device_type  TEXT, -- Mobile, Desktop, Tablet
    os           TEXT, -- iOS, Android, Windows
    browser      TEXT, -- Chrome, Safari
    referer      TEXT
);

-- Indexes for fast Analytics Charts
CREATE INDEX idx_scans_qr_date ON scan_events (qr_id, scanned_at);
CREATE INDEX idx_scans_user_date ON scan_events (user_id, scanned_at);

-- 5. BILLING
CREATE TABLE subscriptions (
    id                UUID PRIMARY KEY,
    user_id           UUID UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    stripe_customer_id TEXT,
    stripe_sub_id     TEXT UNIQUE,
    plan_id           TEXT,        -- 'free', 'pro', 'business'
    status            TEXT,        -- 'active', 'past_due', 'canceled'
    current_period_end TIMESTAMP WITH TIME ZONE
);